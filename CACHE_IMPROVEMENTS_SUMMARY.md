# Улучшения кэширования и отображения модов

## Решенные проблемы

### 1. ✅ Определение запущенных игр
- **Проблема**: Приложение не видело, что игра запущена
- **Решение**: Добавлен `ProcessMonitor` с использованием `psutil`
- **Результат**: Реальное отслеживание запущенных процессов игр

### 2. ✅ Кэширование запросов к Steam
- **Проблема**: Слишком много запросов к Steam → блокировки
- **Решение**: Интегрирован `CacheManager` во все сервисы
- **Результат**: TTL-кэширование с разными сроками для разных данных

### 3. ✅ Отображение изображений модов
- **Проблема**: Изображения не загружались/не отображались
- **Решение**: Улучшен парсинг URL изображений в `SteamWorkshopService`
- **Результат**: Корректное извлечение и отображение превью

### 4. ✅ Названия зависимостей
- **Проблема**: Показывались только ID зависимостей
- **Решение**: Использование кэша для получения названий зависимостей
- **Результат**: Отображение полных названий с ID в tooltip

### 5. ✅ Умная загрузка данных
- **Проблема**: Данные перезагружались при каждой смене игры
- **Решение**: Загрузка только для модов без кэша
- **Результат**: Значительное сокращение запросов к Steam

## Новые компоненты

### ProcessMonitor (`src/core/process_monitor.py`)
```python
# Мониторинг процессов с кэшем на 5 секунд
monitor = ProcessMonitor()
is_running = monitor.is_game_running(executable_path)
```

### CacheManager (`src/core/process_monitor.py`)
```python
# Управление кэшем с TTL
cache = CacheManager()
cache.set(key, data, ttl=3600.0)  # 1 час
cached_data = cache.get(key)
```

### StatusMonitor (`src/core/status_monitor.py`)
```python
# Фоновый мониторинг статуса игр
monitor = StatusMonitor(game_manager, update_interval=3.0)
monitor.start()
```

## Обновленные сервисы

### SteamWorkshopService
- **get_mod_details()**: кэш на 1 час
- **get_mod_update_info()**: кэш на 30 минут  
- **get_cached_mods()**: получение модов из кэша
- **preload_missing_mods()**: загрузка только отсутствующих в кэше
- **invalidate_cache()**: очистка кэша

### GameManager
- **is_game_running()**: реальная проверка через процессы
- **update_all_games_status()**: обновление статуса всех игр
- **get_running_games()**: список запущенных игр

### SteamHandler
- **download_mods()**: кэширование результатов загрузки
- **check_game_status()**: кэширование информации об играх

## Время жизни кэша (TTL)

| Тип данных | TTL | Причина |
|------------|-----|---------|
| Детали модов | 1 час | Редко меняются |
| Информация об обновлениях | 30 минут | Может обновляться |
| Результаты загрузки | 5 минут | Оперативные данные |
| Процессы | 5 секунд | Частые изменения |
| Информация об играх | 10 минут | Статичные данные |

## Кнопки управления

### "Проверить обновления"
- Очищает кэш всех модов текущей игры
- Принудительно загружает актуальные данные
- Показывает прогресс загрузки

### "Обновить все"
- Пока заглушка (требует реализации загрузки)

## Производительность

### До улучшений:
- Запрос к Steam при каждом открытии мода
- Повторная загрузка тех же данных
- Блокировки от Steam при частых запросах
- Отсутствие информации о запущенных играх

### После улучшений:
- Кэширование всех запросов
- Загрузка только новых данных
- Фоновый мониторинг статуса
- Реальное определение запущенных игр

## Обработка ошибок

### Сетевые ошибки
- Кэширование ошибок на короткое время (1 минута)
- Повторные запросы после истечения TTL
- Логирование всех ошибок

### Ошибки доступа к процессам
- Graceful handling в `ProcessMonitor`
- Продолжение работы при недоступности процессов
- Логирование проблем доступа

## Использование

### Базовое использование:
```python
# Проверка статуса игры
is_running = game_manager.is_game_running(steam_id)

# Получение данных мода (с кэшем)
details = steam_service.get_mod_details(mod_id)

# Принудительное обновление
steam_service.invalidate_cache(mod_id)
```

### Продвинутое использование:
```python
# Получение только кэшированных модов
cached_mods = steam_service.get_cached_mods(mod_ids)

# Загрузка отсутствующих в кэше
results = steam_service.preload_missing_mods(mod_ids)

# Фоновый мониторинг
status_monitor.add_status_callback(callback)
status_monitor.start()
```

## Будущие улучшения

1. **Настройки TTL** - пользовательское управление временем жизни кэша
2. **Автоочистка кэша** по размеру или времени
3. **Офлайн-режим** - работа только с кэшированными данными
4. **Статистика кэша** - отображение hit/miss ratio
5. **Пакетная загрузка** - оптимизация групповых запросов

## Файлы кэша

- **Основной кэш**: `src/data/cache.json`
- **Структура**: `{key: {data: ..., timestamp: ..., ttl: ...}}`
- **Автоочистка**: При каждом сохранении

## Итог

Система кэширования решает основные проблемы производительности и предоставляет:
- ✅ Быструю работу с уже загруженными данными
- ✅ Снижение нагрузки на серверы Steam  
- ✅ Реальное определение статуса игр
- ✅ Улучшенное отображение информации о модах
- ✅ Гибкое управление кэшем
