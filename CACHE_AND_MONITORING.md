# Система кэширования и мониторинга игр

## Обзор

В GameModManager добавлена новая система для решения двух основных проблем:
1. **Определение запущенных игр** - приложение теперь корректно определяет, когда игра запущена
2. **Кэширование запросов к Steam** - предотвращает блокировки со стороны Steam при частых запросах

## Компоненты

### 1. ProcessMonitor (`src/core/process_monitor.py`)

Отвечает за мониторинг запущенных процессов Windows.

**Функции:**
- `get_running_processes()` - получение списка запущенных процессов с кэшированием на 5 секунд
- `is_game_running(executable_path)` - проверка, запущена ли конкретная игра

**Особенности:**
- Кэширует список процессов на 5 секунд для снижения нагрузки на CPU
- Проверяет процессы по полному пути и имени файла
- Обрабатывает ошибки доступа к процессам

### 2. CacheManager (`src/core/process_monitor.py`)

Управляет кэшем данных Steam с поддержкой TTL (Time To Live).

**Функции:**
- `get(key, default)` - получение данных из кэша
- `set(key, data, ttl)` - сохранение данных с указанием времени жизни
- `invalidate(key)` - очистка конкретного ключа
- `clear()` - полная очистка кэша

**Особенности:**
- Автоматически удаляет устаревшие записи
- Сохраняет кэш в файл `src/data/cache.json`
- Поддерживает различные TTL для разных типов данных

### 3. StatusMonitor (`src/core/status_monitor.py`)

Фоновый мониторинг статуса игр в отдельном потоке.

**Функции:**
- `start()` - запуск мониторинга
- `stop()` - остановка мониторинга
- `add_status_callback(callback)` - добавление обработчика изменений статуса
- `force_update()` - принудительное обновление статуса

**Особенности:**
- Работает в отдельном потоке без блокировки UI
- Проверяет статус каждые 3 секунды (настраивается)
- Генерирует события при изменении статуса игр

### 4. Обновленный GameManager

Теперь использует ProcessMonitor для определения статуса игр.

**Новые методы:**
- `update_all_games_status()` - обновление статуса всех игр
- `get_running_games()` - получение списка запущенных игр
- `is_game_running()` - реальная проверка через процессы

### 5. Обновленный SteamHandler

Добавлено кэширование результатов запросов к Steam.

**Новые методы:**
- `check_game_status()` - проверка статуса игры с кэшированием
- `invalidate_cache()` - очистка кэша для конкретных данных
- `download_mods()` - теперь кэширует результаты загрузки

## Настройки кэширования

### Время жизни (TTL) по умолчанию:
- **Результаты загрузки модов**: 5 минут (успешные), 1 минута (ошибки)
- **Информация об играх**: 10 минут
- **Процессы**: 5 секунд
- **Файл кэша**: `src/data/cache.json`

### Очистка кэша:
Кэш автоматически очищается при:
- Истечении времени жизни записи
- Явном вызове `invalidate()` или `clear()`
- Изменении настроек Steam

## Использование в коде

### Проверка статуса игры:
```python
# Простая проверка
is_running = game_manager.is_game_running(steam_id)

# Получение всех запущенных игр
running_games = game_manager.get_running_games()
```

### Работа с кэшем Steam:
```python
# Проверка кэша перед запросом
cached_info = steam_handler.cache_manager.get(cache_key)
if cached_info:
    # Используем кэшированные данные
    pass

# Сохранение в кэш
steam_handler.cache_manager.set(key, data, ttl=300.0)
```

### Мониторинг статуса:
```python
# Добавление callback
def on_status_change(steam_id, is_running):
    print(f"Игра {steam_id}: {'Запущена' if is_running else 'Остановлена'}")

status_monitor.add_status_callback(on_status_change)
```

## Преимущества

1. **Точное определение запущенных игр** - через psutil проверяются реальные процессы
2. **Снижение нагрузки на Steam** - кэширование предотвращает блокировки
3. **Автоматическое обновление** - фоновый мониторинг следит за статусом
4. **Гибкая настройка** - различные TTL для разных типов данных
5. **Отказоустойчивость** - обработка ошибок доступа к процессам

## Потенциальные проблемы

1. **Права доступа** - psutil может требовать прав для некоторых процессов
2. **Антивирусы** - могут блокировать частую проверку процессов
3. **Производительность** - при большом количестве игр мониторинг может нагружать CPU

## Решение проблем

### Если игра не определяется как запущенная:
1. Проверьте путь к исполняемому файлу в настройках игры
2. Убедитесь, что игра запущена от имени того же пользователя
3. Проверьте логи на предмет ошибок доступа к процессам

### Если Steam блокирует запросы:
1. Увеличьте TTL для кэша (в коде или настройках)
2. Используйте принудительную очистку кэша при ошибках
3. Добавьте задержки между запросами

## Будущие улучшения

1. **Настройки TTL** - вынести в пользовательский интерфейс
2. **Больше событий** - добавить события для изменения процессов
3. **Статистика** - сбор статистики по использованию кэша
4. **API Steam** - добавить реальные запросы к Steam API
